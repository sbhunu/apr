#!/bin/bash

# Extract Supabase credentials from Docker containers
# This script gets the anon key and service key from the Kong container

echo "ðŸ”‘ Extracting Supabase Credentials from Docker..."
echo "=================================================="
echo ""

# Check if Kong container is running
if ! docker ps --format "{{.Names}}" | grep -q "^supabase-kong$"; then
    echo "âŒ Supabase Kong container not found!"
    echo "   Make sure Supabase is running: docker ps | grep supabase"
    exit 1
fi

echo "âœ… Found Supabase Kong container"
echo ""

# Extract credentials
echo "ðŸ“‹ Extracting credentials..."
ANON_KEY=$(docker exec supabase-kong env | grep "SUPABASE_ANON_KEY" | cut -d'=' -f2)
SERVICE_KEY=$(docker exec supabase-kong env | grep "SUPABASE_SERVICE_KEY" | cut -d'=' -f2)

if [ -z "$ANON_KEY" ]; then
    echo "âŒ Could not extract ANON_KEY"
    exit 1
fi

echo "âœ… Credentials extracted successfully!"
echo ""

# Display credentials (masked for security)
echo "ðŸ“ Credentials Found:"
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
echo "NEXT_PUBLIC_SUPABASE_URL=http://localhost:8000"
echo "NEXT_PUBLIC_SUPABASE_ANON_KEY=${ANON_KEY:0:50}...${ANON_KEY: -20}"
if [ -n "$SERVICE_KEY" ]; then
    echo "SUPABASE_SERVICE_ROLE_KEY=${SERVICE_KEY:0:50}...${SERVICE_KEY: -20}"
fi
echo ""

# Update .env.local
echo "ðŸ’¾ Updating .env.local..."
cat > .env.local << EOF
# Supabase Local Configuration
# Auto-generated by get-docker-credentials.sh

NEXT_PUBLIC_SUPABASE_URL=http://localhost:8000
NEXT_PUBLIC_SUPABASE_ANON_KEY=$ANON_KEY
EOF

if [ -n "$SERVICE_KEY" ]; then
    echo "SUPABASE_SERVICE_ROLE_KEY=$SERVICE_KEY" >> .env.local
fi

echo "âœ… .env.local updated successfully!"
echo ""
echo "ðŸ“‹ File contents:"
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
cat .env.local | sed 's/\(ANON_KEY=\).*/ANON_KEY=***hidden***/' | sed 's/\(SERVICE_ROLE_KEY=\).*/SERVICE_ROLE_KEY=***hidden***/'
echo ""
echo "âœ… Ready to test connection!"
echo ""
echo "ðŸ§ª Next steps:"
echo "   1. Test connection: npm run test:connection"
echo "   2. Run migrations: See QUICK_START.md"
echo ""

